# 0326 Ruby
###### tags: `Ruby`

è¤‡ç¿’ï¼šé¡åˆ¥ classs  vs.  æ¨¡çµ„ module
```ruby=
Class A < B::C::D

end
# ä¸Šæ–¹ç¨‹å¼ç¢¼ä¸­ï¼š B è·Ÿ C å¯èƒ½ç‚ºæ¨¡çµ„ä¹Ÿå¯èƒ½ç‚ºé¡åˆ¥ï¼ŒD çµ•å°æ˜¯é¡åˆ¥
# å› ç‚ºåªæœ‰é¡åˆ¥å¯ä»¥ç¹¼æ‰¿é¡åˆ¥
# æ¨¡çµ„ä¸èƒ½ç¹¼æ‰¿ ä¹Ÿä¸èƒ½.new
```

## æ¸¬è©¦

ä¸Šèª² PPT: [æŠ•å½±ç‰‡ä¸‹è¼‰](https://drive.google.com/file/d/1R7AFivp9J2cnYmF4Cf6wfTcx3fM5qjbj/view?usp=sharing)

Q: ä»€éº¼æ˜¯æ¸¬è©¦ï¼Ÿ
A: ç”¨ä¸€æ®µç¨‹å¼ç¢¼ï¼Œå»æ¸¬è©¦å¦ä¸€æ®µç¨‹å¼ç¢¼


å¯«æ¸¬è©¦çš„æ¦‚å¿µåƒæ˜¯ PM å°‡å®¢äººçš„ä¸­æ–‡è½‰æˆç¨‹å¼ç¢¼
e.g. å®¢äººï¼šæˆ‘æƒ³è¦æœ‰å€‹æŠŠå…©å€‹æ•¸å€¼åŠ èµ·ä¾†çš„æ±è¥¿

Q: ç‚ºä½•è¦æ¸¬è©¦ï¼Ÿ
A: ç¢ºä¿ç¨‹å¼å¯ä»¥ä¾ç…§é æœŸé‹ä½œ / ç¢ºèªçµæœå¦‚è¦åŠƒèˆ¬ç¢ºå¯¦åŸ·è¡Œè€Œåšçš„å‹•ä½œ / æœ‰åŠ©æ–¼åœ¨é–‹ç™¼åˆæœŸé‡æ¸…ç¨‹å¼ä»‹é¢å¦‚ä½•è¨­è¨ˆã€‚

Q: æ¸¬è©¦çš„ç›®çš„ï¼Ÿ
A: ä¸æ˜¯ debugï¼Œæ˜¯è¦åšä¸€å€‹é˜²è­·æ©Ÿåˆ¶

Q: è¦æ€éº¼æ¸¬è©¦é‚„ä¸å­˜åœ¨çš„ç¨‹å¼ç¢¼ï¼Ÿ
A: å‡è¨­ç¨‹å¼ç¢¼å­˜åœ¨

Q: è¦æ€éº¼çŸ¥é“å“ªäº›æ±è¥¿æ‡‰è©²è¦æ¸¬ï¼Ÿ
A: æŒ‰ç…§è¦æ ¼æ›¸é€²è¡Œæ“ä½œï¼Œåœ¨æ„å…¬é–‹çš„éƒ¨åˆ†å°±å¥½ï¼Œç§æœ‰çš„ä¸é‡è¦


æ¸¬è©¦æœ¬èº«å°±æ˜¯è¦æ ¼(Spec)
â€¢ å¯«å‡ºæ›´æœ‰ä¿¡å¿ƒçš„ç¨‹å¼ç¢¼
â€¢ å¯ä»¥åšå‡ºæ¯”è¼ƒå¥½çš„è¨­è¨ˆ
â€¢ å°‡ä¾†æœ‰é‡æ§‹(refactor)çš„å¯èƒ½æ€§



```ruby=
def add
    #.....
end

#test case
puts add(2,5)  #7
puts add(-2,0) #-2
```
â†‘ æœ€ä¸‹é¢å…©è¡Œå°±æ˜¯åœ¨åŸ·è¡Œæ¸¬è©¦ 
 



>äº’å‹•é é¢é©åˆç”¨äººåŠ›é»æ“Šåšæ¸¬è©¦ï¼Œè¡¨æ ¼é¡çš„ä¸é©åˆï¼Œå› ç‚ºäººæœƒæ€ æƒ°å¾ŒçºŒè¼¸å…¥å€¼æœƒæœ‰åå·®ï¼Œæ‰€ä»¥æ‰è¦ä¾é é›»è…¦ï¼ˆç¨‹å¼ï¼‰ä¾†åšæ¸¬è©¦


Q. ç‚ºä»€éº¼ä¸å¯«æ¸¬è©¦?

* æ™‚é–“æœ‰é™
  * å¯«æ¸¬è©¦æœƒèŠ±å°‡è¿‘å¤šä¸€å€çš„æ™‚é–“
* è·‘æ¸¬è©¦å¤ªæ…¢ï¼Œå› ç‚ºæ•¸æ“šå¤ªå¤š
  * è§£å¥—ï¼šæ›å¥½è¨­å‚™æˆ–æ˜¯å§”å¤–
  * ç•¶ç„¶ä¹Ÿå¯ä»¥æ˜¯å€‹ä¸å¯«çš„ç†ç”±
* æ¸¬è©¦å®Œç¨‹å¼å°±å£äº†
  * å¯èƒ½ä»£è¡¨åŸæœ¬çš„ç¨‹å¼ç¢¼æœ‰å•é¡Œ
* ä¸æœƒå¯«æ¸¬è©¦
  * ä½†RUBYåœˆç››è¡Œå¯«æ¸¬è©¦

>å…ˆå¯« Code å†å¯«æ¸¬è©¦è·Ÿ TDD çš„å·®åˆ¥
>>å¤±å»æ¸¬è©¦çš„æ„ç¾©ï¼Œæœƒå½±éŸ¿æ¸¬è©¦çš„çœŸå¯¦æ€§ï¼ˆ**æ¸¬è©¦ç›®çš„ä¸æ˜¯debugï¼Œè€Œæ˜¯è¦åšä¸€å€‹é˜²è­·æ©Ÿåˆ¶**ï¼‰

---

### å¦‚ä½•é–‹å§‹å¯«æ¸¬è©¦ï¼Ÿ

**3A åŸå‰‡** (ä¸‹æ–¹ç¯„ä¾‹ä¸­èªªæ˜)

1. Arrange å®‰æ’ (æº–å‚™æ¸¬è©¦ç’°å¢ƒ)
2. Act æ“ä½œ (åŸ·è¡Œæ¸¬è©¦æ–¹æ³•)
3. Assert è©•ä¼°/æ–·è¨€ (è©•ä¼°æ¸¬è©¦çµæœ)
4. è£œå……èªªæ˜ï¼šhttps://bit.ly/39hgMFk


---


## Test-Driven Development (TDD) æ¸¬è©¦é©…å‹•é–‹ç™¼


  - å…ˆå¯«æ¸¬è©¦å€‹æ¡ˆ (test case) å†å¯«ç¨‹å¼ç¢¼ï¼Œç¢ºä¿ç¨‹å¼å¯ä»¥ä¾ç…§é æœŸè¡Œç‚ºé‹ä½œ
  - é€™æ˜¯ä¸€ç¨®é–‹ç™¼æ–¹æ³•ï¼Œä¸€ç¨®æµç¨‹
  - æ¸¬è©¦**ä¸å­˜åœ¨**çš„åŠŸèƒ½ï¼Œ**å‡è¨­**ä»–å¯ä»¥æ­£å¸¸é‹ä½œ
  - æ¸¬è©¦å€‹æ¡ˆé€šå¸¸æœƒæœ‰ã€Œç‰¹æ®Š / è‡¨ç•Œå€¼ã€
  - æ„ˆç™½è©±æ„ˆå¥½
  - æ¸¬è©¦å¯«åˆ°ä¸­é–“å¦‚æœå¤ªé †åˆ©ï¼Œå¯ä»¥æ•…æ„æ”¾ä¸€å€‹æœƒå¤±æ•—çš„ä¾‹å­çœ‹æ¸¬è©¦æ˜¯å¦æœƒåµæ¸¬åˆ°

**è‡¨ç•Œå€¼ï¼ˆç‰¹æ®Šå€¼ï¼‰çš„ä¾‹å­ï¼š**
- å­˜ç„¡é™å¤§æœƒå¦‚ä½•
- å­˜ nil æœƒå¦‚ä½•

**RUBY åœˆå¸¸ç”¨èªè¨€æ¸¬è©¦å·¥å…·**
 - minitest 
   - é€Ÿåº¦è¼ƒå¿« 
   - ç®—æ˜¯RUBYå…§å»ºï¼Œç”­å¦å¤–å®‰è£
   - è¼ƒé›£å¯«
 - RSpec (R é–‹é ­ä»£è¡¨ Ruby)
   - é€Ÿåº¦è¼ƒæ…¢ 
   - èªæ³•è±å¯Œ 
   - é¡ä¼¼è‹±æ–‡ã€å¥½å¯« 
   - è³‡æºå¤šã€å¸‚ä½”ç‡è¼ƒé«˜

### ä½¿ç”¨ RSpec åŸ·è¡Œæ¸¬è©¦

---
å®˜æ–¹æ–‡ä»¶ï¼š[æŒ‰é€™è£¡ğŸ§¡](https://rspec.info/documentation/3.10/rspec-core/)
```ruby=
RSpec.describe
#èµ·æ‰‹å¼
```
```ruby=
ã€ RSpec æ–¹æ³• ã€‘

describe # åŠŸèƒ½æè¿° |
context  # åŸ·è¡Œæƒ…å¢ƒ | å…©è€…åŒåŠŸèƒ½ï¼Œåªæ˜¯èªæ„ä¸åŒ
it  # åŸ·è¡ŒåŠŸèƒ½çš„æè¿°
expect(å¸¶å…¥å€¼).to be é æœŸå€¼

# åŸå‹ expect(å¸¶å…¥å€¼).to(be(é æœŸå€¼)) 
```
expect ç¯„ä¾‹ï¼š
```ruby=
expect(1).to be 1   -> é æœŸ(1)æ˜¯ 1
expect(1).to be 2   -> é æœŸ(1)æ˜¯ 2 ä½†ä»£å…¥ 1 æ‰€ä»¥å£äº†
```
æ¸¬è©¦æª”çš„å‘½åæ–¹å¼
  - é€šå¸¸æœƒåœ¨å¾Œé¢åŠ  "_spec" æ¨™ç¤ºæ˜¯æ¸¬è©¦æª”æ¡ˆ
  - ç¯„ä¾‹ï¼šatm_spec.rb

é€šå¸¸æœƒå°‡å¯¦ä½œæª”è·Ÿæ¸¬è©¦æª”åˆ†é–‹ï¼Œä¹‹å¾Œå†å¾æ¸¬è©¦æª”è£¡å¸¶å…¥å¯¦ä½œæª”
```ruby=
# åœ¨æ¸¬è©¦æª”ä¸­ï¼ˆe.g. atm_spec.rb) åŠ åœ¨æœ€ä¸Šæ–¹
require "./å¯¦ä½œæª”.rb"

#..... åœ¨åº•ä¸‹å¯«ä¸Šæ¸¬è©¦å…§å®¹
```
****é€šå¸¸åœ¨ä¸€å€‹ `it` æ–¹æ³•ä¸­åªæœƒä½¿ç”¨**ä¸€å€‹** `expect` æ¸¬è©¦**ä¸€å€‹**é æœŸå€¼ï¼Œè‹¥ç”¨åˆ°å…©å€‹çš„è©±éœ€è¦æ˜¯æ–¹å‘ä¸€æ¨£****

åŸ·è¡Œæ¸¬è©¦
```
$ rspec æ¸¬è©¦æª”å.rb
```
è¨­è¨ˆæ–¹æ³•æ™‚ï¼Œä¹Ÿå¯è¨­å®šç¢ºèªæ–¹æ³•çš„**å›å‚³å€¼** ï¼ˆè¦‹ä¸‹æ–¹ç¯„ä¾‹ï¼‰

#### refactor é‡æ§‹ï¼šä¸å½±éŸ¿å¤–åœ¨å‰æ (å…¬é–‹ä»‹é¢) ä¸‹åšèª¿æ•´ -> æ”¹å¾—æ›´ç²¾ç°¡
- æ¸¬è©¦å…¬é–‹æ–¹æ³•(è¡Œç‚º)`(public method)`
- é‡æ§‹å…§éƒ¨çµæ§‹
- é‡æ§‹å®Œè¦è¨˜å¾—å†æ¸¬è©¦ä¸€æ¬¡ç¢ºèªæ˜¯å¦æœ‰éŒ¯èª¤

---

## æ¸¬è©¦å¯¦ä½œç¯„ä¾‹

é–‹ç™¼ATM
 * **å­˜éŒ¢åŠŸèƒ½**
   * å¯ä»¥å­˜éŒ¢
   * ä¸å¯ä»¥å­˜0å…ƒæˆ–å°æ–¼0å…ƒ
 * **é ˜éŒ¢åŠŸèƒ½**
   * å¯ä»¥é ˜éŒ¢
   * ä¸èƒ½é ˜0å…ƒæˆ–å°æ–¼0å…ƒ
   * ä¸èƒ½é ˜è¶…éæœ¬èº«é¤˜é¡


æ¸¬è©¦æª” (atm_spec.rb)
```ruby=
require ./atm

#é¡åˆ¥æ–¹æ³•(åƒæ•¸/å»ºè­°å¸¶å¸¸æ•¸ï¼Œä¹Ÿå¯å¸¶å­—ä¸²)
RSpec.describe (ATM) do
  context "å­˜éŒ¢" do #åšåˆ†é¡ï¼Œä¸å¯«ä¸æœƒæœ‰å½±éŸ¿
    it "å¯ä»¥å­˜éŒ¢" do #ä»–æœƒç™¼ç”Ÿå¯ä»¥å­˜éŒ¢é€™ä»¶äº‹æƒ…ï¼Œä¸€å€‹æè¿°
            #æ¸¬è©¦å€‹æ¡ˆå¯«åœ¨é€™è£¡â†“ (æ­é… 3A åŸå‰‡)
      atm = ATM.new(10)    # Arrange å®‰æ’
      atm.deposit(5)    # Act æ“ä½œ
      expect(atm.balance).to be 15    #Assert è©•ä¼°
    end
  end
  
  context "é ˜éŒ¢" do
    it "å¯ä»¥é ˜éŒ¢" do
      atm = ATM.new(10)
      money = atm.withdraw(5)
      expect(atm.balance).to be 5
      expect(money).to be 5
    end

    it "ä¸èƒ½é ˜0å…ƒæˆ–å°æ–¼0å…ƒ" do
      atm = ATM.new(20)         
      money = atm.withdraw(-5)
      expect(atm.balance).to be 20
      expect(money).to be 0
    end
  end
end
  ```



å¯¦ä½œæª”å…§å®¹ (atm.rb)
```ruby=
#ã€Œä¸èƒ½é ˜0å…ƒæˆ–å°æ–¼0å…ƒã€
def withdraw(money)
  if money > 0 and money <= @amount
    @amount -= money     # ç­‰æ–¼ @amount = @amount - money
    return money    # è¦æœ‰å›å‚³å€¼ï¼Œå¦å‰‡å›å‚³çš„æ˜¯ @amount è€Œé money å€¼
  else
    return 0
  end
end
```
é‡æ§‹å¯¦ä½œæª”
- å®šç¾©æ–¹æ³•çš„ç›®çš„ï¼šç‚ºç¨‹å¼ç¢¼è³¦äºˆæ„ç¾©
```ruby=
class ATM
  attr_reader :balance  # è¦æ³¨æ„æ‰€æœ‰å‚³é€²å»çš„è®Šæ•¸åç¨±éƒ½è¦ä½¿ç”¨ balance

  def initialize(balance)
    @balance = balance
  end

  def deposit(money)
    @balance += money if money > 0
  end

  def withdraw(money)
    if money > 0 and enough?(money)  # åŠ å…¥ä¸‹æ–¹çš„ private
      @balance = @balance - money
      return money
    else
      return 0
    end
  end

  private            # ä¸å¯«ä¹Ÿæ²’é—œä¿‚ï¼Œä½†ç›®çš„æ˜¯è®“æ¥æ‰‹å°ˆæ¡ˆçš„äººå®¹æ˜“ç†è§£ï¼†ç¶­è­·
  def enough?(money)
    money <= @balance
  end
end
```

---

### åœ¨ RSpec ä¸­ä½¿ Arrange ä¸ç”¨é‡è¤‡çš„æ–¹æ³•
#### RSpec æä¾›ä¸€å€‹ `let` çš„æ–¹æ³•ä»¥æ¸›å°‘é‡è¤‡çš„èªæ³•
ç¯„ä¾‹ï¼š
```ruby=
# åœ¨åŒä¸€å€‹ context/ describe Block ä¸­ä½¿ç”¨
let(:atm) { ATM.new(10) }
```
å¯çœå» it ä¸­ï¼š
```ruby=
atm = ATM.new(10)
```


ç¯„ä¾‹ï¼š
```ruby=
describe "é ˜éŒ¢" do

  let(:atm) { ATM.new(10) } 

    it "å¯ä»¥é ˜éŒ¢" do 
      #atm = ATM.new(10)  => ä½¿ç”¨letæ–¹æ³•å¯ä»¥ä¸ç”¨å¯«é€™å€‹
      money = atm.withdraw(5)
      expect(atm.balance).to be 5
      expect(money).to be 5
      #åœ¨é€™è£¡é¢moneyå¯ä»¥å¯«ä¸­æ–‡
    end
      
    it "ä¸èƒ½é ˜ 0 å…ƒæˆ–æ˜¯å°æ–¼ 0 å…ƒçš„é‡‘é¡" do 
      #atm = ATM.new(10)  => ä½¿ç”¨letæ–¹æ³•å¯ä»¥ä¸ç”¨å¯«é€™å€‹
      money = atm.withdraw(-5)
      expect(atm.balance).to be 10
      expect(money).to be 0
    end
end
```


---

## é¡Œå¤–è©±å€‘
- æœƒå¯«æ¸¬è©¦çš„ QA å¾ˆå€¼éŒ¢ğŸ‘€
- æœƒè·Ÿå®¢äººæºé€šä¸”çŸ¥é“éœ€æ±‚å·¥æ™‚çš„ PM æœƒå¾ˆå—æ­¡è¿
  - æœƒæ¸¬è©¦çš„ QA è·Ÿ PM æ¯”å¯« code çš„å·¥ç¨‹å¸«å€¼éŒ¢
- é¢è©¦æœ€å¾Œä¸€å•å¯ä»¥å•ï¼šè²´å…¬å¸æœ‰æ²’æœ‰ä½¿ç”¨ç‰ˆæ§ (ä¸æ˜¯Gitä¹Ÿè¡Œ) æˆ–åœ¨é–‹ç™¼æµç¨‹ä¸­å¯«æ¸¬è©¦ï¼Ÿ
- è€æ‰‹è·Ÿæ–°æ‰‹äº¤éŒ¯å¯«æ¸¬è©¦å°æ–°äººç™¼å±•å’Œåœ˜éšŠåˆä½œæœ‰å¹«åŠ©
- Behavior-driven Development (BDD) æ˜¯ä¸€ç¨® TDD æ–¹æ³•
  - å¼•è¿°è‡ª RSpec å®˜ç¶²ï¼šBDD è®“ TDD æ›´æœ‰æ•ˆç‡ä¹Ÿæ›´æœ‰è¶£ğŸ§¡
  - https://rspec.info  ï¼ é¾å“¥èªªè¦çœ‹
![](https://i.imgur.com/6it8JRE.png =450x)
- Unit Test æ˜¯æ¸¬è©¦çš„***æœ€å°***å–®ä½ï¼Œé‡å°ä¸€å€‹æœ‰åŠŸèƒ½çš„ç‰¹å®šæ¨¡çµ„æˆ–ç‰©ä»¶é€²è¡Œæ¸¬è©¦ï¼Œä¾‹å¦‚é‡å°ä¸€å€‹ Class åšæ¸¬è©¦ã€‚(æ¥è‘—å¯ä»¥å†å° Model, Controller, View æ•´é«”é€²è¡Œæ¸¬è©¦=>æ•´åˆæ¸¬è©¦) - 

* é¾å“¥å¥½æ›¸åˆ†äº«ï¼š"Testing with RSpec"/é›»å­æ›¸
https://leanpub.com/everydayrailsrspec


---

ã„‹


